apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  namespace: default
  labels:
    app: postgres
data:
  init.sql: |
    -- Create sample schema for tracing demo
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(100) NOT NULL UNIQUE,
        email VARCHAR(255) NOT NULL,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    CREATE TABLE IF NOT EXISTS quotes (
        id SERIAL PRIMARY KEY,
        content TEXT NOT NULL,
        author VARCHAR(255),
        fetched_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        source VARCHAR(100) DEFAULT 'quotable.io'
    );

    CREATE TABLE IF NOT EXISTS weather_cache (
        id SERIAL PRIMARY KEY,
        location VARCHAR(255) NOT NULL UNIQUE,
        data JSONB NOT NULL,
        cached_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        expires_at TIMESTAMP WITH TIME ZONE
    );

    CREATE TABLE IF NOT EXISTS request_logs (
        id SERIAL PRIMARY KEY,
        trace_id VARCHAR(32),
        span_id VARCHAR(16),
        request_id VARCHAR(36),
        endpoint VARCHAR(255),
        method VARCHAR(10),
        status_code INTEGER,
        duration_ms BIGINT,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes for better query performance
    CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
    CREATE INDEX IF NOT EXISTS idx_quotes_author ON quotes(author);
    CREATE INDEX IF NOT EXISTS idx_weather_cache_location ON weather_cache(location);
    CREATE INDEX IF NOT EXISTS idx_request_logs_trace_id ON request_logs(trace_id);
    CREATE INDEX IF NOT EXISTS idx_request_logs_created_at ON request_logs(created_at);

    -- Insert sample data
    INSERT INTO users (username, email) VALUES
        ('alice', 'alice@example.com'),
        ('bob', 'bob@example.com'),
        ('charlie', 'charlie@example.com')
    ON CONFLICT (username) DO NOTHING;
